server:
  port: 8080

spring:
  application:
    name: workforce-gateway
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 16
          min-idle: 2

  cloud:
    gateway:
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns: "${CORS_ALLOWED_ORIGINS:*}"
            allowedMethods: [GET, POST, PUT, DELETE, OPTIONS]
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600
      routes:
        # ── Auth Service (public — no JWT required) ──────────────────────────
        - id: auth-service
          uri: ${AUTH_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/auth/**
          filters:
            - name: CorrelationIdFilter
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 20
                redis-rate-limiter.burstCapacity: 40
                key-resolver: "#{@ipKeyResolver}"

        # ── Upload Service (JWT required) ────────────────────────────────────
        - id: upload-service
          uri: ${UPLOAD_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/v1/uploads/**
          filters:
            - name: JwtAuthenticationFilter
            - name: TenantPropagationFilter
            - name: CorrelationIdFilter
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 50
                redis-rate-limiter.burstCapacity: 100
                key-resolver: "#{@ipKeyResolver}"

        # ── Query Service (JWT required) ─────────────────────────────────────
        - id: query-service
          uri: ${QUERY_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/v1/employees/**
          filters:
            - name: JwtAuthenticationFilter
            - name: TenantPropagationFilter
            - name: CorrelationIdFilter
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
                key-resolver: "#{@ipKeyResolver}"

# ── JWT (must match auth-service config exactly) ─────────────────────────────
jwt:
  secret: ${JWT_SECRET:changeme-use-a-32-char-secret-in-prod!}
  issuer: ${JWT_ISSUER:workforcehub}

# ── Public paths (skip JWT check) ────────────────────────────────────────────
security:
  public-paths:
    - /auth/**
    - /actuator/health
    - /actuator/info
    - /fallback/**

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,gateway
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}

resilience4j:
  circuitbreaker:
    instances:
      uploadCircuitBreaker:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
      queryCircuitBreaker:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 10s

logging:
  level:
    root: INFO
    com.workforce: DEBUG
